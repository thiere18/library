version: '3.7'
services:
  redis:
    image: redis
    ports:
      - 6379:6379
  pgadmin:
    container_name: pgadmin
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=password
    ports:
      - 5050:80
    depends_on:
      - postgres

  celery_worker:
    image: ghcr.io/sigularusrex/cura:latest
    command: celery --app app.tasks worker --loglevel=DEBUG -Q main-queue -c 1
    depends_on:
      - backend
      - redis

  flower:  
    image: mher/flower
    command: celery --broker=redis://redis:6379/0 flower --port=5555

    ports:  
        - 5555:5555
    depends_on:
      - backend
      - redis
      - celery_worker
  backend:
    image: ghcr.io/sigularusrex/cura:latest
    command: python app/main.py
    tty: true
    ports:
      - 8000:8000
    environment:
      PYTHONPATH: .
      DATABASE_URL: 'postgresql://curas_admin@curass:tlo4413!E@curass.postgres.database.azure.com:5432/cura'